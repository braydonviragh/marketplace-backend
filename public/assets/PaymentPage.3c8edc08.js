import{y as O,c as k,B as F,j as w,_ as K,r as l,m as Q,J as j,L,o as _,a as x,d as e,f as p,t as i,p as I,N as U,w as A,Q as R,O as J,g as G,h as H,ad as N,ac as W}from"./index.aed2db9c.js";import{u as Z,a as X,b as ee}from"./use-checkbox.4b330bec.js";import{Q as te}from"./QSpinnerDots.464d7f1c.js";import{u as V}from"./use-quasar.274aa12c.js";import{d as se}from"./date.d974a712.js";import"./private.use-form.e6da8665.js";import"./format.8ac60962.js";var ae=O({name:"QToggle",props:{...Z,icon:String,iconColor:String},emits:X,setup(g){function h(y,c){const n=k(()=>(y.value===!0?g.checkedIcon:c.value===!0?g.indeterminateIcon:g.uncheckedIcon)||g.icon),r=k(()=>y.value===!0?g.iconColor:null);return()=>[F("div",{class:"q-toggle__track"}),F("div",{class:"q-toggle__thumb absolute flex flex-center no-wrap"},n.value!==void 0?[F(w,{name:n.value,color:r.value})]:void 0)]}return ee("toggle",h)}});const re={class:"stripe-payment-form"},oe={key:0,class:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6"},le={class:"flex items-start"},ne={class:"flex-shrink-0"},ie={class:"ml-3"},de={class:"mt-1 text-sm"},ce={class:"card-container mb-5 relative"},ue={key:0,class:"mt-1 text-sm text-red-600"},me={class:"mt-3 flex items-center text-xs text-gray-500"},pe={class:"payment-options mb-6"},ve={class:"payment-summary mb-6 bg-gray-50 p-4 rounded-lg"},ye={class:"flex justify-between text-sm mb-2"},fe={class:"flex justify-between text-sm mb-2"},_e={class:"flex justify-between font-medium mt-2"},ge={class:"text-primary"},xe={class:"payment-button"},be={__name:"StripePaymentForm",props:{offerId:{type:[Number,String],required:!0},amount:{type:Number,required:!0},serviceFeePercent:{type:Number,default:8.5}},emits:["payment-success","payment-error"],setup(g,{emit:h}){const y=g,c=h;V();const n=l(null),r=l(null),d=l(null),b=l(null),P=l(!1),f=l(!1),v=l(""),S=l(""),o=l(""),a=l(""),m=l(!1),E=l(!1),z=k(()=>y.amount),T=k(()=>y.amount*(y.serviceFeePercent/100)),C=k(()=>z.value+T.value),$=s=>(Math.round(s*100)/100).toFixed(2);Q(async()=>{try{const s={}.VITE_STRIPE_KEY||"pk_test_51QtZcrKOOwUlWjVHILEHs7GLAlam1RotfVkql2yU5DrbO3kaREjIxBESz0F031oaYiryJtK4NcytwyZ447pkDJM700F9rGRKwE";n.value=await q(s),await D()}catch(s){console.error("Error loading Stripe:",s),v.value="Could not load payment processor. Please try again later."}});const D=async()=>{var s,t;try{const u=await j.post("/payments",{offer_id:y.offerId,payment_method:"stripe"});o.value=u.data.data.client_secret,a.value=u.data.data.payment.stripe_payment_intent_id,B()}catch(u){console.error("Error initializing payment:",u),v.value=((t=(s=u.response)==null?void 0:s.data)==null?void 0:t.message)||"Failed to initialize payment. Please try again."}},B=()=>{!n.value||!b.value||(r.value=n.value.elements({locale:"en",appearance:{theme:"stripe",variables:{colorPrimary:"#6366f1",borderRadius:"8px",fontFamily:'-apple-system, "system-ui", sans-serif'}}}),d.value=r.value.create("card",{hidePostalCode:!0,style:{base:{color:"#424770",fontWeight:"500",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#9e2146",iconColor:"#9e2146"}}}),d.value.mount(b.value),d.value.on("change",s=>{P.value=s.complete,S.value=s.error?s.error.message:""}),d.value.on("focus",()=>m.value=!0),d.value.on("blur",()=>m.value=!1))},M=async()=>{if(!(!n.value||!r.value||!P.value)){f.value=!0,v.value="";try{const{error:s,paymentIntent:t}=await n.value.confirmCardPayment(o.value,{payment_method:{card:d.value,billing_details:{}},save_payment_method:E.value});if(s){v.value=s.message,f.value=!1,c("payment-error",s);return}t.status==="succeeded"?(await Y(),console.log("Payment successful!"),c("payment-success",{paymentIntentId:t.id,amount:C.value})):(v.value="Payment processing failed. Please try again.",c("payment-error",{message:"Payment processing failed"}))}catch(s){console.error("Payment error:",s),v.value=s.message||"An unexpected error occurred",c("payment-error",s)}finally{f.value=!1}}},Y=async()=>{try{await j.post("/payments/confirm",{payment_intent_id:a.value})}catch(s){console.error("Error confirming payment on server:",s)}},q=async s=>window.Stripe?window.Stripe(s):new Promise(t=>{const u=document.createElement("script");u.src="https://js.stripe.com/v3/",u.async=!0,u.onload=()=>{t(window.Stripe(s))},document.head.appendChild(u)});return L(()=>{d.value&&d.value.unmount()}),(s,t)=>(_(),x("div",re,[v.value?(_(),x("div",oe,[e("div",le,[e("div",ne,[p(w,{name:"error",size:"sm",class:"text-red-500 mt-0.5"})]),e("div",ie,[t[1]||(t[1]=e("h3",{class:"text-sm font-medium"},"Payment Error",-1)),e("div",de,i(v.value),1)])])])):I("",!0),e("div",ce,[t[3]||(t[3]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Card Details",-1)),e("div",{ref_key:"cardElement",ref:b,class:U(["p-4 border border-gray-300 bg-white rounded-lg",{"border-primary":m.value}])},null,2),S.value?(_(),x("div",ue,i(S.value),1)):I("",!0),e("div",me,[p(w,{name:"lock",size:"xs",class:"mr-1"}),t[2]||(t[2]=e("span",null,"Payment data secured with 256-bit encryption",-1))])]),e("div",pe,[t[4]||(t[4]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Save Card",-1)),p(ae,{modelValue:E.value,"onUpdate:modelValue":t[0]||(t[0]=u=>E.value=u),label:"Save card for future payments",color:"primary"},null,8,["modelValue"]),t[5]||(t[5]=e("div",{class:"text-xs text-gray-500 mt-1 ml-9"}," Your card will be securely stored for faster checkout ",-1))]),e("div",ve,[t[9]||(t[9]=e("h3",{class:"text-sm font-medium text-gray-700 mb-3"},"Payment Summary",-1)),e("div",ye,[t[6]||(t[6]=e("span",{class:"text-gray-600"},"Rental total",-1)),e("span",null,"$"+i($(z.value)),1)]),e("div",fe,[t[7]||(t[7]=e("span",{class:"text-gray-600"},"Service fee",-1)),e("span",null,"$"+i($(T.value)),1)]),t[10]||(t[10]=e("div",{class:"border-t border-gray-200 my-2"},null,-1)),e("div",_e,[t[8]||(t[8]=e("span",null,"Total",-1)),e("span",ge,"$"+i($(C.value)),1)])]),e("div",xe,[p(R,{label:f.value?"Processing...":`Pay $${$(C.value)}`,color:"primary",class:"w-full py-2",rounded:"",disable:!P.value||f.value,loading:f.value,onClick:M},{loading:A(()=>[p(te,{color:"white"})]),_:1},8,["label","disable","loading"]),t[11]||(t[11]=e("div",{class:"text-center text-xs text-gray-500 mt-3"},[J(" By completing this payment, you agree to our "),e("a",{href:"#",class:"text-primary hover:underline"},"Terms of Service")],-1))])]))}};var he=K(be,[["__scopeId","data-v-d39d8a6a"]]);const Pe={class:"bg-gray-50 min-h-screen"},we={class:"max-w-4xl mx-auto p-4 sm:p-6"},Se={class:"grid grid-cols-1 lg:grid-cols-12 gap-8"},ke={class:"lg:col-span-7 order-2 lg:order-1"},$e={class:"bg-white rounded-xl shadow-sm p-6"},Ie={key:1,class:"py-12 flex justify-center"},Ee={key:2,class:"py-12"},Ce={class:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md"},Fe={class:"flex"},je={class:"flex-shrink-0"},ze={class:"ml-3"},Te={class:"mt-2 text-sm"},Ne={class:"mt-4"},Qe={class:"lg:col-span-5 order-1 lg:order-2"},Re={class:"bg-white rounded-xl shadow-sm p-6 sticky top-6"},Ve={key:0,class:"py-8 flex justify-center"},De={key:1},Be={class:"mb-6"},Me=["src","alt"],Ye={class:"mb-6"},qe={class:"font-medium text-lg mb-1"},Oe={class:"text-gray-600 text-sm mb-2"},Ke={class:"flex items-center text-sm text-gray-600 mb-1"},Le={class:"flex items-center text-sm text-gray-600"},Ue={class:"border-t border-gray-200 pt-4"},Ae={class:"flex justify-between mb-2"},Je={class:"flex justify-between mb-2"},Ge={class:"flex justify-between font-medium"},at={__name:"PaymentPage",setup(g){const h=W(),y=G();V();const c=l(!0),n=l(""),r=l(null),d=l(h.params.id||h.query.offerId),b=o=>(Math.round(o*100)/100).toFixed(2),P=o=>o?se.formatDate(o,"MMM D, YYYY"):"",f=async()=>{var o,a;if(!d.value){n.value="No offer ID provided",c.value=!1;return}c.value=!0,n.value="";try{const m=await j.get(`/offers/${d.value}`);r.value=m.data.data,r.value.status!=="accepted"&&(n.value="This offer cannot be paid for because it has not been accepted.")}catch(m){console.error("Error fetching offer:",m),n.value=((a=(o=m.response)==null?void 0:o.data)==null?void 0:a.message)||"Failed to load offer details"}finally{c.value=!1}},v=o=>{console.log("Payment successful!",o),setTimeout(()=>{y.push({path:"/payment-success",query:{paymentId:o.paymentIntentId,offerId:d.value}})},1500)},S=o=>{console.error("Payment error:",o)};return Q(()=>{f()}),(o,a)=>{var m;return _(),x("div",Pe,[e("div",we,[a[8]||(a[8]=e("div",{class:"mb-8"},[e("h1",{class:"text-3xl font-bold text-gray-900 mb-2"},"Complete Your Payment"),e("p",{class:"text-gray-600"},"Secure your rental by completing the payment details")],-1)),e("div",Se,[e("div",ke,[e("div",$e,[a[1]||(a[1]=e("h2",{class:"text-xl font-semibold mb-4"},"Payment Method",-1)),r.value?(_(),H(he,{key:0,"offer-id":d.value,amount:r.value.price,onPaymentSuccess:v,onPaymentError:S},null,8,["offer-id","amount"])):c.value?(_(),x("div",Ie,[p(N,{color:"primary",size:"3em"})])):n.value?(_(),x("div",Ee,[e("div",Ce,[e("div",Fe,[e("div",je,[p(w,{name:"error",class:"mt-0.5"})]),e("div",ze,[a[0]||(a[0]=e("h3",{class:"text-sm font-medium"},"Error Loading Offer",-1)),e("div",Te,i(n.value),1),e("div",Ne,[p(R,{outline:"",color:"primary",label:"Try again",onClick:f})])])])])])):I("",!0)])]),e("div",Qe,[e("div",Re,[a[7]||(a[7]=e("h2",{class:"text-xl font-semibold mb-4"},"Rental Summary",-1)),c.value?(_(),x("div",Ve,[p(N,{color:"primary",size:"2em"})])):r.value&&r.value.product?(_(),x("div",De,[e("div",Be,[e("img",{src:r.value.product.image_url||"https://via.placeholder.com/300x200",alt:r.value.product.title,class:"w-full h-48 object-cover rounded-lg"},null,8,Me)]),e("div",Ye,[e("h3",qe,i(r.value.product.title),1),e("p",Oe,i(r.value.product.description),1),e("div",Ke,[p(w,{name:"event",size:"xs",class:"mr-2"}),e("span",null,i(P(r.value.start_date))+" - "+i(P(r.value.end_date)),1)]),e("div",Le,[p(w,{name:"person",size:"xs",class:"mr-2"}),e("span",null,i(((m=r.value.product.user)==null?void 0:m.name)||"Seller"),1)])]),e("div",Ue,[e("div",Ae,[a[2]||(a[2]=e("span",{class:"text-gray-600"},"Rental price",-1)),e("span",null,"$"+i(b(r.value.price)),1)]),e("div",Je,[a[3]||(a[3]=e("span",{class:"text-gray-600"},"Service fee",-1)),e("span",null,"$"+i(b(r.value.price*.085)),1)]),a[5]||(a[5]=e("div",{class:"border-t border-gray-200 my-2"},null,-1)),e("div",Ge,[a[4]||(a[4]=e("span",null,"Total",-1)),e("span",null,"$"+i(b(r.value.price*1.085)),1)])]),a[6]||(a[6]=e("div",{class:"mt-6 p-3 bg-gray-50 rounded-lg text-sm"},[e("p",{class:"font-medium mb-1"},"Cancellation Policy"),e("p",{class:"text-gray-600"},"Free cancellation up to 48 hours before the rental date. After that, the first day's rental fee is non-refundable.")],-1))])):I("",!0)])])])])])}}};export{at as default};
